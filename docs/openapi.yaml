openapi: 3.0.1
info:
  title: Arborist
  version: 1.1.1
  description: authorization microservice to handle RBAC based on configured policies
  license:
    name: 'Apache 2.0'
    url: 'https://github.com/uc-cdis/arborist'
tags:
  - name: auth
    description: make requests to determine authorization
  - name: resource
    description: manage resources in the arborist database
  - name: role
    description: manage roles in the arborist database
  - name: policy
    description: manage policies to grant authorization
paths:
  /auth/request:
    post:
      tags:
        - auth
      description: >-
        Ask arborist to check authorization on a user request. A client of the
        Gen3 auth stack sends the user's JWT to this endpoint, along with the
        information about the user's specific request. The terminology used to
        describe user requests is flexible and arborist does not "nail it down";
        however our usage so far is to use the permission model to capture the
        basic set of operations one might expect in RBAC (read/write, etc.)
        combined with the client service, and the path for the resource the user
        is trying to access. If the given JWT has `azp` field, the permission of
        the corresponding client will be also checked; only when both the user
        and the client have permission can the response be positive.
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthRequestBody'
      responses:
        200:
          description: >-
            Arborist successfully returned an authorization decision. NOTE
            that a 200 status DOES NOT indicate authorization, only that the
            input was valid. The `"auth"` field in the response indicates
            authorization.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthRequestResponse'
        400:
          description: >-
            The input was somehow invalid; for example, a given resource does
            not exist.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserError'
  /auth/resources:
    post:
      tags:
        - auth
      description: >-
        Given a user token, return a list of resources which are accessible to
        the user (using any action) according to the policies listed in the
        token.
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthResourcesRequestBody'
      responses:
        200:
          description: >-
            Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResourcesResponse'
        400:
          description: invalid input (missing fields or fields have incorrect types)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserError'
        401:
          description: >-
            Token failed to validate (authentication error)
  /health:
    get:
      tags:
        - health
      description: >-
        Check that the arborist instance is healthy and the database is
        available.
      responses:
        200:
          description: Healthy
        500:
          description: Unhealthy (database ping failed)
  /resource:
    get:
      tags:
        - resource
      description: >-
        List all resources which have been created in arborist. The resources in
        arborist are saved in a tree structure; however this endpoint will
        traverse through all the resources and return a flattened list of just
        the full resource paths for all available resources.
      responses:
        200:
          description: list of resources
          content:
            application/json:
              schema:
                type: object
                properties:
                  resource_paths:
                    type: array
                    items:
                      type: string
                    example: ["/data_file", "/programs", "/", "/programs/DEV","/programs/DEV/projects","/programs/DEV/projects/test"]
  /resource/{resourcePath}:
    parameters:
      - in: path
        name: resourcePath
        required: true
        schema:
          type: string
        allowReserved: true
        description: >-
          The full path for a resource, which includes slashes. For example, if
          a resource was created which has the path `/a/b/c`, then the endpoint
          `/resource/a/b/c` can now be used to access this resource.
    get:
      tags:
        - resource
      description: Read the resource given by the path
      responses:
        200:
          description: JSON representation of the specified resource
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Resource'
        404:
          description: no resource exists with the given `resourcePath`
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotFound'
    post:
      tags:
        - resource
      description: >-
        Add a new subresource, *underneath* an existing resource. The path *is
        allowed to be empty*; when `resourcePath` is empty, the resource is
        created under the root resource, as `/new_resource`.
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResourceInput'
      responses:
        201:
          description: JSON representation of successfully-created resource
          content:
            application/json:
              schema:
                type: object
                properties:
                  created:
                    $ref: '#/components/schemas/Resource'
        404:
          description: no resource exists with the given `resourcePath`
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserError'
    put:
      tags:
        - resource
      description: >-
        Overwrite an existing resource. This endpoint requires a fully-formed
        resource model (and cannot patch over individual fields on the existing
        resources). If the specified resource doesn't exist, it will be created.
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResourceInput'
      responses:
        201:
          description: JSON representation of successfully-updated resource
          content:
            application/json:
              schema:
                type: object
                properties:
                  updated:
                    $ref: '#/components/schemas/Resource'
        400:
          description: invalid input (missing fields or fields have incorrect types)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserError'
    delete:
      tags:
        - resource
      responses:
        204:
          description: resource successfully deleted
        404:
          description: no resource exists with the given `resourcePath`
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotFound'
  /role:
    get:
      tags:
        - role
      description: List all the roles registered in arborist.
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Roles'
    post:
      tags:
        - role
      description: Create a new role
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Role'
      responses:
        201:
          description: Success; returns JSON representation of created role
          content:
            application/json:
              schema:
                type: object
                properties:
                  created:
                    $ref: '#/components/schemas/Role'
        400:
          description: invalid input (missing fields or fields have incorrect types)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserError'
  /role/{roleID}:
    parameters:
      - in: path
        name: roleID
        required: true
        schema:
          type: string
        description: The ID for a role registered in arborist.
    get:
      tags:
        - role
      description: >-
        Output the information for a specific role.
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
        404:
          description: no role exists with the given `roleID`
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotFound'
    put:
      tags:
        - role
      description: >-
        Overwrite an existing role with new content. This endpoint requires a
        fully-formed role (and cannot patch over individual fields on the
        existing resources).
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Role'
      responses:
        201:
          description: Success; returns JSON representation of updated role
          content:
            application/json:
              schema:
                type: object
                properties:
                  updated:
                    $ref: '#/components/schemas/Role'
        400:
          description: invalid input (missing fields or fields have incorrect types)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserError'
        404:
          description: no role exists with the given `roleID`
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotFound'
    patch:
      tags:
        - role
      description: >-
        Append information to an existing role. The contents of all the fields
        provided in a `PATCH` request are appended to the existing fields on
        this role.
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Role'
      responses:
        201:
          description: Success; returns JSON representation of updated role
          content:
            application/json:
              schema:
                type: object
                properties:
                  updated:
                    $ref: '#/components/schemas/Role'
        400:
          description: invalid input (missing fields or fields have incorrect types)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserError'
        404:
          description: no role exists with the given `roleID`
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotFound'
    delete:
      tags:
        - role
      description: Delete this role.
      responses:
        204:
          description: role successfully deleted
        404:
          description: no role exists with the given `roleID`
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotFound'
  /policy:
    get:
      tags:
        - policy
      description: >-
        List just the IDs for all policies which have been created in arborist.
      responses:
        200:
          description: list of resources
          content:
            application/json:
              schema:
                type: object
                properties:
                  policy_ids:
                    type: array
                    items:
                      type: string
                example:
                  policy_ids: ["programs.DEV-update","programs.DEV-delete","data_upload","programs.DEV-read","programs.DEV-create","programs.DEV-upload"]
    post:
      tags:
        - policy
      description: Create a new policy
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Policy'
      responses:
        201:
          description: Success; returns JSON representation of created policy
          content:
            application/json:
              schema:
                type: object
                properties:
                  created:
                    $ref: '#/components/schemas/Policy'
        400:
          description: invalid input (missing fields or fields have incorrect types)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserError'
  /policy/{policyID}:
    parameters:
      - in: path
        name: policyID
        required: true
        schema:
          type: string
        description: The ID for a policy registered in arborist.
    get:
      tags:
        - policy
      description: >-
        Output the information for a specific policy.
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Policy'
        404:
          description: no role exists with the given `policyID`
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotFound'
    put:
      tags:
        - policy
      description: >-
        Overwrite an existing policy with new content. This endpoint requires a
        fully-formed policy (and cannot patch over individual fields on the
        existing resources).
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Policy'
      responses:
        201:
          description: Success; returns JSON representation of updated policy
          content:
            application/json:
              schema:
                type: object
                properties:
                  updated:
                    $ref: '#/components/schemas/Policy'
        400:
          description: invalid input (missing fields or fields have incorrect types)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserError'
        404:
          description: no policy exists with the given `policyID`
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotFound'
    patch:
      tags:
        - policy
      description: >-
        Append information to an existing policy. The contents of all the fields
        provided in a `PATCH` request are appended to the existing fields on
        this policy.
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Policy'
      responses:
        201:
          description: Success; returns JSON representation of updated policy
          content:
            application/json:
              schema:
                type: object
                properties:
                  updated:
                    $ref: '#/components/schemas/Policy'
        400:
          description: invalid input (missing fields or fields have incorrect types)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserError'
        404:
          description: no policy exists with the given `policyID`
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotFound'
    delete:
      tags:
        - policy
      description: Delete this policy.
      responses:
        204:
          description: policy successfully deleted
        404:
          description: no policy exists with the given `policyID`
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotFound'
  /user:
    get:
      tags:
        - user
      description: >-
        List all the users registered in arborist.
      responses:
        200:
          description: list of users
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UsersList'
    post:
      tags:
        - user
      description: >-
        Create a new user
      responses:
        201:
          description: created user
          content:
            application/json:
              schema:
                type: object
                properties:
                  created:
                    $ref: '#/components/schemas/User'
  /user/{username}:
    parameters:
      - in: path
        name: username
        required: true
        schema:
          type: string
        description: the username for a user registered in arborist
    get:
      tags:
        - user
      description: >-
        Read the information for a specific user.
      responses:
        200:
          description: user information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        404:
          description: user not found
    delete:
      tags:
        - user
      description: >-
        Delete this user from the database.
      responses:
        204:
          description: user successfully deleted
        404:
          description: user not found
  /user/{username}/policy:
    parameters:
      - in: path
        name: username
        required: true
        schema:
          type: string
        description: the username for a user registered in arborist
    post:
      tags:
        - user
      description: >-
        Grant an additional policy to a user. The policy must exist already.
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GrantPolicy'
      responses:
        204:
          description: successfully granted additional policy
        404:
          description: user not found, or policy not found
    delete:
      tags:
        - user
      description: >-
        Revoke all policies for this user.
      responses:
        204:
          description: successfully revoked policies
  /user/{username}/policy/{policyName}:
    parameters:
      - in: path
        name: username
        required: true
        schema:
          type: string
        description: the username for a user registered in arborist
      - in: path
        name: policyName
        required: true
        schema:
          type: string
        description: the name for a policy
    delete:
      tags:
        - user
      description: >-
        Revoke this policy from this user, so they will no longer have access.
      responses:
        204:
          description: successfully revoked
        404:
          description: user not found
  /client:
    get:
      tags:
        - client
      description: >-
        List all the clients registered in arborist.
      responses:
        200:
          description: list of clients
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientsList'
    post:
      tags:
        - client
      description: >-
        Create a new client
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Client'
      responses:
        201:
          description: created client
          content:
            application/json:
              schema:
                type: object
                properties:
                  created:
                    $ref: '#/components/schemas/Client'
  /client/{clientID}:
    parameters:
      - in: path
        name: clientID
        required: true
        schema:
          type: string
        description: the client ID for a client registered in arborist
    get:
      tags:
        - client
      description: >-
        Read the information for a specific client.
      responses:
        200:
          description: client information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Client'
        404:
          description: client not found
    delete:
      tags:
        - client
      description: >-
        Delete this client from the database.
      responses:
        204:
          description: client successfully deleted
        404:
          description: client not found
  /client/{clientID}/policy:
    parameters:
      - in: path
        name: clientID
        required: true
        schema:
          type: string
        description: the client ID for a client registered in arborist
    post:
      tags:
        - client
      description: >-
        Grant an additional policy to a client. The policy must exist already.
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GrantPolicy'
      responses:
        204:
          description: successfully granted additional policy
        404:
          description: client not found, or policy not found
    delete:
      tags:
        - client
      description: >-
        Revoke all policies for this client.
      responses:
        204:
          description: successfully revoked policies
  /client/{clientID}/policy/{policyName}:
    parameters:
      - in: path
        name: clientID
        required: true
        schema:
          type: string
        description: the client ID for a client registered in arborist
      - in: path
        name: policyName
        required: true
        schema:
          type: string
        description: the name for a policy
    delete:
      tags:
        - client
      description: >-
        Revoke this policy from this client, so they will no longer have access.
      responses:
        204:
          description: successfully revoked
        404:
          description: client not found
  /group:
    get:
      tags:
        - group
      description: >-
        List all the groups registered in arborist.
      responses:
        200:
          description: list of groups
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string
                  example: 'group'
    post:
      tags:
        - group
      description: >-
        Create a new group
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Group'
      responses:
        201:
          description: created group
          content:
            application/json:
              schema:
                type: object
                properties:
                  created:
                    $ref: '#/components/schemas/Group'
  /group/{groupName}:
    parameters:
      - in: path
        name: groupName
        required: true
        schema:
          type: string
        description: the groupName for a group registered in arborist
    get:
      tags:
        - group
      description: >-
        Read the information for a specific group.
      responses:
        200:
          description: group information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Group'
        404:
          description: group not found
    delete:
      tags:
        - group
      description: >-
        Delete this group from the database.
      responses:
        204:
          description: group successfully deleted
        404:
          description: group not found
  /group/{groupName}/policy:
    parameters:
      - in: path
        name: groupName
        required: true
        schema:
          type: string
        description: the groupName for a group registered in arborist
    post:
      tags:
        - group
      description: >-
        Grant an additional policy to a group. The policy must exist already.
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GrantPolicy'
      responses:
        204:
          description: successfully granted additional policy
        404:
          description: group not found, or policy not found
  /group/{groupName}/policy/{policyName}:
    parameters:
      - in: path
        name: groupName
        required: true
        schema:
          type: string
        description: the groupName for a group registered in arborist
      - in: path
        name: policyName
        required: true
        schema:
          type: string
        description: the name for a policy
    delete:
      tags:
        - group
      description: >-
        Revoke this policy from this group, so they will no longer have access.
      responses:
        204:
          description: successfully revoked
        404:
          description: group not found
components:
  schemas:
    AuthRequestBody:
      type: object
      properties:
        user:
          type: object
          properties:
            token:
              type: string
              description: >-
                A JWT token belonging to a user, as defined by RFC 7519.
              example: 'eyJhbGciOiJFUzI1NiIsImtpZCI6IjE2In0[...]'
        request:
          type: object
          description: >-
              The action and resource a user is trying to access. Instead of
              `request` the API also accepts `requests` which should be an array
              of these objects. When using `requests`, arborist will return true
              if the user has access for every request in the list, though they
              may be granted via different policies.
          properties:
            resource:
              type: string
              example: '/programs/DEV/projects/test'
            action:
              type: object
              properties:
                service:
                  type: string
                  example: 'fence'
                method:
                  type: string
                  example: 'read-storage'
              required:
                - service
                  method
          required:
            - token
          requests:
            type: array
            items:
              type: object
              description: >-
                Same as the `request` field. Use `requests` to send multiple
                auth requests. Arborist returns positive authorization if every
                request in the list succeeds.
              properties:
                resource:
                  type: string
                  example: '/programs/DEV/projects/test'
                action:
                  type: object
                  properties:
                    service:
                      type: string
                      example: 'fence'
                    method:
                      type: string
                      example: 'read-storage'
                  required:
                    - service
                      method
              required:
                - token
    AuthRequestResponse:
      type: object
      properties:
        auth:
          type: boolean
    AuthResourcesRequestBody:
      type: object
      properties:
        user:
          type: object
          properties:
            token:
              type: string
              example: 'eyJhbGciOiJFUzI1NiIsImtpZCI6IjE2In0[...]'
          required:
            - token
      required:
        - user
    AuthResourcesResponse:
      type: object
      properties:
        resources:
          type: array
          items:
            type: string
          example: ['/programs/DEV/projects/test', '/programs/foo/projects/bar']
    UserError:
      type: object
      properties:
        error:
          type: object
          properties:
            message:
              type: string
              description: an explanation of the error that occurred
            code:
              type: integer
              description: the HTTP error code
      example:
        error:
          message: "input resource is missing the following required fields: ..."
          code: 400
    NotFound:
      type: object
      properties:
        error:
          type: object
          properties:
            message:
              type: string
              description: an explanation of the error that occurred
            code:
              type: integer
              description: the HTTP error code
      example:
        error:
          message: "resource with path `/foo/bar` does not exist"
          code: 404
    Resource:
      type: object
      properties:
        name:
          type: string
          description: >-
            The name (final path segment) of this particular resource. The names
            are not globally unique; they must be unique only within the
            "directory" of the tree they live in.  example: "programs"
        path:
          type: string
          description: >-
            The full path to this resource, which is formed from the list of resource
            names starting from the root and continuing down to this one, joined by slashes.
            Note that the path is generated by arborist and should not be included in the
            input value.
          example: "/programs"
        description:
          type: string
        subresources:
          type: array
          description: nested Resource items
          items:
            type: string
          example:  ["/programs/DEV-1", "/programs/DEV-2"]
    ResourceInput:
      type: object
      description: >-
        Input resources require *either* the `name` field, if the resource is
        input as the immediate child of another resource node, or the `path`
        field if submitted at the root resource endpoint. Note that the name
        and path are only allowed to contain alphanumeric characters and
        underscores.
      properties:
        name:
          type: string
          description: >-
            The name (final path segment) of this particular resource. The names
            are not globally unique; they must be unique only within the
            "directory" of the tree they live in.  example: "programs"
        path:
          type: string
          description: >-
            The full path to this resource, which is formed from the list of resource
            names starting from the root and continuing down to this one, joined by slashes.
            Note that the path is generated by arborist and should not be included in the
            input value.
          example: "/programs"
        description:
          type: string
        subresources:
          type: array
          description: nested Resource items
          items:
            type: string
          example:  ["/programs/DEV-1", "/programs/DEV-2"]
    Roles:
      type: object
      properties:
        role_ids:
          type: array
          items:
            type: string
      example:
        role_ids: ["create","upload","update","delete","file_uploader","read"]
    Role:
      type: object
      properties:
        id:
          type: string
          description: a name which uniquely identifies this role in arborist
          example: "read"
        description:
          type: string
          description: some optional human-readable information about the role
        permissions:
          type: array
          items:
            $ref: '#/components/schemas/Permission'
      required:
        - id
          permissions
    Permission:
      type: object
      description: a permission to do a specific action.
      properties:
        id:
          type: string
          description: a name which uniquely identifies this permission in arborist
          example: "read"
        description:
          type: string
          description: some optional human-readable information about the permission
        action:
          type: object
          description: a model for an action that a user can do
          properties:
            service:
              type: string
              description: >-
                the service in which the action is granted; or, `"*"` to grant
                the role for all, arbitrary services
              example: "fence"
            method:
              type: string
              description: >-
                a basic operation such as read or write; could also use RESTful
                language such as GET/POST/etc.
              example: "read"
          required:
            - service
              method
      required:
        - id
          action
    Policy:
      type: object
      properties:
        id:
          type: string
          description: a name which uniquely identifies this permission in arborist
        role_ids:
          type: array
          description: a list of role IDs
          items:
            type: string
          example: ["upload"]
        resource_paths:
          type: array
          description: a list of resource paths
          items:
            type: string
          example: ["/programs/DEV/projects/test"]
    GrantPolicy:
      type: object
      properties:
        policy:
          type: string
          description: the policy to grant
          example: 'policy_name'
    User:
      type: object
      properties:
        name:
          type: string
          example: 'username'
        email:
          type: string
          example: 'user@example.net'
        groups:
          type: array
          items:
            type: string
            example: 'group'
        policies:
          type: array
          items:
            type: string
            example: 'policy'
    UsersList:
      type: object
      properties:
        users:
          type: array
          items:
            type: string
            example: 'username'
    Client:
      type: object
      properties:
        clientID:
          type: string
          example: 'x68GTbL0NHOV085t51jEuJW3vDrng3G5hr7p1B4l'
        policies:
          type: array
          items:
            type: string
            example: 'policy'
    ClientsList:
      type: object
      properties:
        clients:
          type: array
          items:
            type: string
            example: 'x68GTbL0NHOV085t51jEuJW3vDrng3G5hr7p1B4l'
    Group:
      type: object
      properties:
        name:
          type: string
          example: 'example_group'
        users:
          type: array
          items:
            type: string
            example: 'username'
        policies:
          type: array
          items:
            type: string
            example: 'policy'
